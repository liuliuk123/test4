<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢å•ç¡®è®¤ - liuliuçš„å•†åŸ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* å¤´éƒ¨ */
        .header {
            background-color: #fff;
            padding: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }

        .header-title {
            font-size: 20px;
            color: #666;
        }

        /* ä¸»è¦å†…å®¹ */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .section {
            background-color: #fff;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
        }

        /* æ”¶è´§åœ°å€ */
        .address-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .address-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .address-card:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.2);
        }

        .address-card.selected {
            border-color: #007bff;
            background-color: #f0f8ff;
        }

        .address-default {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #e63946;
            color: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .address-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .address-phone {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .address-detail {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }

        .no-address {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .add-address-btn {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 20px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
        }

        .add-address-btn:hover {
            background-color: #0056b3;
        }

        /* å•†å“åˆ—è¡¨ */
        .product-list {
            border-top: 1px solid #eee;
        }

        .product-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .product-item:last-child {
            border-bottom: none;
        }

        .product-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 15px;
        }

        .product-info {
            flex-grow: 1;
        }

        .product-name {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 5px;
            color: #333;
        }

        .product-price {
            color: #e63946;
            font-size: 14px;
        }

        .product-quantity {
            color: #666;
            font-size: 14px;
        }

        .product-subtotal {
            font-size: 16px;
            font-weight: 600;
            color: #e63946;
            text-align: right;
            min-width: 100px;
        }

        /* è®¢å•æ‘˜è¦ */
        .order-summary {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 15px;
        }

        .summary-row.total {
            font-size: 20px;
            font-weight: 600;
            color: #e63946;
            padding-top: 15px;
            border-top: 2px solid #ddd;
        }

        /* æ”¯ä»˜æ–¹å¼ */
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .payment-method {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-method:hover {
            border-color: #007bff;
        }

        .payment-method.selected {
            border-color: #007bff;
            background-color: #f0f8ff;
        }

        .payment-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .payment-name {
            font-size: 14px;
            color: #333;
        }

        /* å¤‡æ³¨ */
        .remark-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }

        .remark-input:focus {
            outline: none;
            border-color: #007bff;
        }

        /* æäº¤æŒ‰é’® */
        .submit-section {
            margin-top: 30px;
            text-align: right;
        }

        .submit-btn {
            background-color: #28a745;
            color: #fff;
            border: none;
            padding: 15px 60px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .submit-btn:hover {
            background-color: #218838;
        }

        .submit-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* è¿”å›æŒ‰é’® */
        .back-btn {
            display: inline-block;
            margin-bottom: 20px;
            padding: 8px 20px;
            background-color: #6c757d;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
        }

        .back-btn:hover {
            background-color: #5a6268;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .product-item {
                flex-wrap: wrap;
            }

            .product-img {
                width: 60px;
                height: 60px;
            }

            .product-subtotal {
                width: 100%;
                text-align: left;
                margin-top: 10px;
            }

            .address-list,
            .payment-methods {
                grid-template-columns: 1fr;
            }

            .submit-btn {
                width: 100%;
                padding: 12px 30px;
            }
        }

        /* åŠ è½½ä¸­ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <!-- å¤´éƒ¨ -->
    <header class="header">
        <div class="container">
            <div class="logo">liuliuçš„å•†åŸ</div>
            <div class="header-title">è®¢å•ç¡®è®¤</div>
        </div>
    </header>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="container">
        <a href="index.html" class="back-btn">â† è¿”å›è´­ç‰©</a>

        <div class="main-content">
            <!-- æ”¶è´§åœ°å€ -->
            <div class="section">
                <h2 class="section-title">1. é€‰æ‹©æ”¶è´§åœ°å€</h2>
                <div id="addressList" class="address-list">
                    <div class="loading">æ­£åœ¨åŠ è½½åœ°å€...</div>
                </div>
            </div>

            <!-- å•†å“æ¸…å• -->
            <div class="section">
                <h2 class="section-title">2. ç¡®è®¤è®¢å•å•†å“</h2>
                <div id="productList" class="product-list">
                    <div class="loading">æ­£åœ¨åŠ è½½å•†å“...</div>
                </div>
            </div>

            <!-- æ”¯ä»˜æ–¹å¼ -->
            <div class="section">
                <h2 class="section-title">3. é€‰æ‹©æ”¯ä»˜æ–¹å¼</h2>
                <div class="payment-methods">
                    <div class="payment-method selected" data-method="alipay">
                        <div class="payment-icon">ğŸ’³</div>
                        <div class="payment-name">æ”¯ä»˜å®</div>
                    </div>
                    <div class="payment-method" data-method="wechat">
                        <div class="payment-icon">ğŸ’š</div>
                        <div class="payment-name">å¾®ä¿¡æ”¯ä»˜</div>
                    </div>
                    <div class="payment-method" data-method="bank">
                        <div class="payment-icon">ğŸ¦</div>
                        <div class="payment-name">é“¶è¡Œå¡</div>
                    </div>
                    <div class="payment-method" data-method="cod">
                        <div class="payment-icon">ğŸ’°</div>
                        <div class="payment-name">è´§åˆ°ä»˜æ¬¾</div>
                    </div>
                </div>
            </div>

            <!-- è®¢å•å¤‡æ³¨ -->
            <div class="section">
                <h2 class="section-title">4. è®¢å•å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰</h2>
                <textarea id="remarkInput" class="remark-input" placeholder="å¦‚æœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œè¯·åœ¨æ­¤å¡«å†™..."></textarea>
            </div>

            <!-- è®¢å•æ‘˜è¦ -->
            <div class="section">
                <div class="order-summary">
                    <div class="summary-row">
                        <span>å•†å“æ€»ä»·ï¼š</span>
                        <span id="goodsTotal">Â¥ 0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>è¿è´¹ï¼š</span>
                        <span id="shippingFee">Â¥ 0.00</span>
                    </div>
                    <div class="summary-row total">
                        <span>åº”ä»˜æ€»é¢ï¼š</span>
                        <span id="orderTotal">Â¥ 0.00</span>
                    </div>
                </div>

                <div class="submit-section">
                    <button id="submitBtn" class="submit-btn">æäº¤è®¢å•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥APIå·¥å…· -->
    <script src="js/api.js"></script>

    <script>
        // è®¢å•æ•°æ®
        let orderData = {
            cartItems: [],
            selectedAddress: null,
            paymentMethod: 'alipay',
            remark: '',
            totalAmount: 0
        };

        document.addEventListener('DOMContentLoaded', () => {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            checkLoginStatus();

            // åŠ è½½è´­ç‰©è½¦æ•°æ®
            loadCartData();

            // åŠ è½½åœ°å€åˆ—è¡¨
            loadAddresses();

            // ç»‘å®šäº‹ä»¶
            bindEvents();
        });

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            const userToken = localStorage.getItem('user_token');
            if (!userToken) {
                alert('è¯·å…ˆç™»å½•ï¼');
                window.location.href = 'ç™»å½•.html';
                return false;
            }
            return true;
        }

        // åŠ è½½è´­ç‰©è½¦æ•°æ®
        function loadCartData() {
            const cartJson = localStorage.getItem('shoppingCart');
            if (!cartJson) {
                alert('è´­ç‰©è½¦ä¸ºç©ºï¼');
                window.location.href = 'index.html';
                return;
            }

            try {
                orderData.cartItems = JSON.parse(cartJson);
                if (orderData.cartItems.length === 0) {
                    alert('è´­ç‰©è½¦ä¸ºç©ºï¼');
                    window.location.href = 'index.html';
                    return;
                }
                renderProducts();
                calculateTotal();
            } catch (e) {
                console.error('è§£æè´­ç‰©è½¦æ•°æ®å¤±è´¥:', e);
                alert('è´­ç‰©è½¦æ•°æ®é”™è¯¯ï¼');
                window.location.href = 'index.html';
            }
        }

        // æ¸²æŸ“å•†å“åˆ—è¡¨
        function renderProducts() {
            const productList = document.getElementById('productList');
            productList.innerHTML = '';

            orderData.cartItems.forEach(item => {
                const productItem = document.createElement('div');
                productItem.className = 'product-item';
                productItem.innerHTML = `
                    <img src="${item.image || 'https://picsum.photos/80/80'}" alt="${item.name}" class="product-img">
                    <div class="product-info">
                        <div class="product-name">${item.name}</div>
                        <div class="product-price">Â¥ ${item.price.toFixed(2)}</div>
                        <div class="product-quantity">æ•°é‡ï¼š${item.quantity}</div>
                    </div>
                    <div class="product-subtotal">Â¥ ${(item.price * item.quantity).toFixed(2)}</div>
                `;
                productList.appendChild(productItem);
            });
        }

        // åŠ è½½åœ°å€åˆ—è¡¨
        async function loadAddresses() {
            const addressList = document.getElementById('addressList');
            
            try {
                // å°è¯•ä»APIåŠ è½½åœ°å€
                const result = await api.getAddresses();
                
                if (result.success && result.data && result.data.length > 0) {
                    renderAddresses(result.data);
                    // è‡ªåŠ¨é€‰æ‹©é»˜è®¤åœ°å€
                    const defaultAddr = result.data.find(addr => addr.is_default);
                    if (defaultAddr) {
                        orderData.selectedAddress = defaultAddr;
                    } else {
                        orderData.selectedAddress = result.data[0];
                    }
                } else {
                    // æ²¡æœ‰åœ°å€ï¼Œæ˜¾ç¤ºæç¤º
                    loadLocalAddresses();
                    // addressList.innerHTML = `
                    //     <div class="no-address">
                    //         <p>æ‚¨è¿˜æ²¡æœ‰æ”¶è´§åœ°å€</p>
                    //         <a href="vip.html" class="add-address-btn">å»æ·»åŠ åœ°å€</a>
                    //     </div>
                    // `;
                }
            } catch (error) {
                console.error('åŠ è½½åœ°å€å¤±è´¥:', error);
                // APIå¤±è´¥ï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½åœ°å€ï¼ˆå…¼å®¹vip.htmlçš„åœ°å€æ•°æ®ï¼‰
                loadLocalAddresses();
            }
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½åœ°å€ï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰
        function loadLocalAddresses() {
            const addressList = document.getElementById('addressList');
            
            // æ¨¡æ‹Ÿåœ°å€æ•°æ®ï¼ˆå®é™…åº”è¯¥ä»APIè·å–ï¼‰
            const mockAddresses = [
                {
                    id: 1,
                    receiver_name: 'æ”¶è´§äºº',
                    phone: '13800138000',
                    province: 'äº‘å—çœ',
                    city: 'æ™®æ´±å¸‚',
                    area: 'æ€èŒ…åŒº',
                    detail_address: 'è¯·åœ¨ä¸ªäººä¸­å¿ƒæ·»åŠ æ”¶è´§åœ°å€',
                    is_default: 1
                }
            ];

            renderAddresses(mockAddresses);
            orderData.selectedAddress = mockAddresses[0];
        }

        // æ¸²æŸ“åœ°å€åˆ—è¡¨
        function renderAddresses(addresses) {
            const addressList = document.getElementById('addressList');
            addressList.innerHTML = '';

            addresses.forEach(addr => {
                const addressCard = document.createElement('div');
                addressCard.className = 'address-card';
                if (orderData.selectedAddress && orderData.selectedAddress.id === addr.id) {
                    addressCard.classList.add('selected');
                }
                
                addressCard.innerHTML = `
                    ${addr.is_default ? '<div class="address-default">é»˜è®¤</div>' : ''}
                    <div class="address-name">${addr.receiver_name}</div>
                    <div class="address-phone">${addr.phone}</div>
                    <div class="address-detail">
                        ${addr.province} ${addr.city} ${addr.area} ${addr.detail_address}
                    </div>
                `;
                
                addressCard.addEventListener('click', () => {
                    selectAddress(addr);
                });
                
                addressList.appendChild(addressCard);
            });
        }

        // é€‰æ‹©åœ°å€
        function selectAddress(address) {
            orderData.selectedAddress = address;
            
            // æ›´æ–°UI
            document.querySelectorAll('.address-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // æ”¯ä»˜æ–¹å¼é€‰æ‹©
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', function() {
                    document.querySelectorAll('.payment-method').forEach(m => {
                        m.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    orderData.paymentMethod = this.dataset.method;
                });
            });

            // å¤‡æ³¨è¾“å…¥
            document.getElementById('remarkInput').addEventListener('input', function() {
                orderData.remark = this.value.trim();
            });

            // æäº¤è®¢å•
            document.getElementById('submitBtn').addEventListener('click', submitOrder);
        }

        // è®¡ç®—æ€»é‡‘é¢
        function calculateTotal() {
            const goodsTotal = orderData.cartItems.reduce((total, item) => {
                return total + (item.price * item.quantity);
            }, 0);

            const shippingFee = goodsTotal >= 99 ? 0 : 10; // æ»¡99åŒ…é‚®
            const orderTotal = goodsTotal + shippingFee;

            orderData.totalAmount = orderTotal;

            document.getElementById('goodsTotal').textContent = `Â¥ ${goodsTotal.toFixed(2)}`;
            document.getElementById('shippingFee').textContent = shippingFee === 0 ? 'å…è¿è´¹' : `Â¥ ${shippingFee.toFixed(2)}`;
            document.getElementById('orderTotal').textContent = `Â¥ ${orderTotal.toFixed(2)}`;
        }

        // æäº¤è®¢å•
        async function submitOrder() {
            // éªŒè¯åœ°å€
            if (!orderData.selectedAddress) {
                alert('è¯·é€‰æ‹©æ”¶è´§åœ°å€ï¼');
                return;
            }

            // éªŒè¯å•†å“
            if (orderData.cartItems.length === 0) {
                alert('è´­ç‰©è½¦ä¸ºç©ºï¼');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'æäº¤ä¸­...';

            try {
                // è°ƒç”¨APIåˆ›å»ºè®¢å•
                const result = await api.createOrder({
                    items: orderData.cartItems,
                    address_id: orderData.selectedAddress.id,
                    payment_method: orderData.paymentMethod,
                    remark: orderData.remark
                });
                
                if (result.success) {
                    // æ¸…ç©ºè´­ç‰©è½¦
                    localStorage.removeItem('shoppingCart');
                    
                    // ä¿å­˜è®¢å•ä¿¡æ¯
                    const orderInfo = {
                        orderNo: result.data.order_no,
                        orderId: result.data.order_id,
                        totalAmount: orderData.totalAmount,
                        address: orderData.selectedAddress,
                        items: orderData.cartItems,
                        paymentMethod: orderData.paymentMethod,
                        createTime: new Date().toLocaleString('zh-CN')
                    };
                    localStorage.setItem('lastOrder', JSON.stringify(orderInfo));
                    
                    // è·³è½¬åˆ°è®¢å•æˆåŠŸé¡µé¢
                    window.location.href = 'order-success.html';
                } else {
                    throw new Error(result.message || 'è®¢å•åˆ›å»ºå¤±è´¥');
                }

            } catch (error) {
                console.error('æäº¤è®¢å•å¤±è´¥:', error);
                alert('è®¢å•æäº¤å¤±è´¥ï¼š' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'æäº¤è®¢å•';
            }
        }
    </script>
</body>
</html>

